\chapter{Radiative transfer simulations - {\sl uvspec}}
\label{chap:rt}

%\section{Overview}
The {\sl uvspec} program calculates the radiation field in the
Earth's atmosphere. Input to the model are the constituents of the
atmosphere including various molecules, aerosols and clouds. The
absorption and scattering properties of these constituents may either
be taken from the algorithms and databases provided with {\sl
  libRadtran} and {\sl uvspec} or be provided by the user. Boundary
conditions are the solar spectrum at the top of the atmosphere and the
reflecting surface at the bottom. Several extraterrestrial solar
spectra are provided with {\sl libRadtran} and various surface models
are also included. 

{\sl uvspec} is structured into the following three
essential parts:  (1) An atmospheric shell 
which converts atmospheric properties like ozone profile, surface
pressure, or cloud microphysical parameters into optical properties
required as input to (2) the radiative transfer equation solver which
calculates radiances, irradiances, actinic fluxes and heating rates
for the given optical properties; and (3) post-processing of the
solver output including multiplication with the extraterrestrial solar
irradiance correction of Earth-Sun distance, convolution with a
slit-function, or integration over wavelength (depending on the choice
of the user). For an overview see Figure~\ref{fig:uvspec_structure}.
\begin{figure}[htbp]
  \centering
  \includegraphics[width=0.9\textwidth]{figs/figure1}
  \caption{Structure of the {\sl uvspec} model}
  \label{fig:uvspec_structure}
\end{figure}


The core of all radiative transfer models is a method to calculate the
radiation field for a given distribution of optical properties by
solving the radiative transfer equation. To solve the radiative
transfer equation discussed in Chapter~\ref{chap:rttheory} 
{\sl uvspec} has the unique feature of giving the user a choice of
various  radiative transfer solvers (table~\ref{tab:rte_solvers}).
This implies that for the radiative transfer problem at hand an
appropriate solver may 
be chosen, e.g. a fast two-stream code to calculate approximate
irradiance or a discrete ordinate code to accurately simulate
radiances, with or without polarization. 
\ifmystic{
  The full 3D radiative 
  transfer equation may be solved by the Monte Carlo solver MYSTIC. Please note
  that the public release includes only a 1D version of MYSTIC.}

Below the basic usage of {\sl uvspec} is described first followed by
a general description of the {\sl uvspec} input file and output file. The
{\sl uvspec} input file may either be generated manually using any
text editor capable of saving files in ASCII (plain text) format, or
it may be generated by the {\sl uvspec} Graphical User Interface
found in the \file{GUI} folder. The input/output file description is 
followed by a brief description of the radiative transfer equation solvers 
available in {\sl uvspec}. Finally several examples of usage of {\sl uvspec} 
are given.

\section{Basic usage}

\subsection{Running {\sl uvspec}}

{\sl uvspec} reads 
from standard input, and outputs to standard output. It is normally
invoked in the following way\footnote{The Graphical User Interface to
{\sl uvspec} provides another convenient way. \index{uvspec@{\sl uvspec} as
a callable function} {\sl uvspec}
may also be called as a function from another C program. See
\file{src/worldloop.c} for an example.}:

\begin{Verbatim}[fontsize=\footnotesize] 
  uvspec < input_file > output_file
\end{Verbatim}
  
\noindent The formats of the input and output files are described
below. Several realistic examples of input files are 
given in section~\ref{sec:examples}.

\noindent {\sl uvspec} may produce a wealth of diagnostic
messages and warnings, depending on your use of \codeidx{verbose} or
\codeidx{quiet}.  Diagnostics, error messages, and warnings are written
to \code{stderr} while the {\sl uvspec} output is written to
\code{stdout}. To make use of this extra information, you may want to
write the standard {\sl uvspec} output to one file and the diagnostic
messages to another. To do so, try \code{(./uvspec < uvspec.inp >
uvspec.out) >\& verbose.txt}. The irradiances and radiances will be
written to \file{uvspec.out} while all diagnostic messages go into
\file{verbose.txt}. This method can also be used to collect
{\sl uvspec} error messages.

{\bf Warning:} Please note the error checking on input variables is
not complete at the moment. Hence, if you provide erroneous input, the
outcome is unpredictable.

\subsection{The {\sl uvspec} input file}

{\sl uvspec}
is controlled in a user-friendly way. The control options are named in
a (hopefully) intuitive way. 

The {\sl uvspec} input file consists of single line entries, each
making up a complete input to {\sl uvspec}. First on the
line comes the option name, followed by one or more parameter
values. The option name and the parameter values are separated by
white space.  Filenames are entered without any surrounding single or
double quotes.  Comments are introduced by a \code{\#}. Blank lines
are ignored. The order of the lines is not important, with one
exception: if the same input option is used more than once, the second
one will usually over-write the first one. Be aware that also options
in another included input file will overwrite options specified
before.


\subsection{How to setup an input file for your problem (checklist)}

There are several steps to consider when setting up an input file for
your specific problem. First of all we strongly recommend that you
read a radiative transfer textbook to become familiar with what is
required for your problem. Below is a short checklist including the
steps you need to consider for each problem:

\begin{enumerate}

\item {\bf Wavelength grid / band parameterization}
 
  By default, libRadtran employs the REPTRAN band parameterization 
  with a spectral resolution of 15~cm$^{-1}$. It allows to calculate
  quantities integrated over narrow spectral bands. You need to
  specify a wavelength range using \codeidx{wavelength}. 
  The wavelengths for which the radiative transfer calculations are performed are
  determined by the parameterization and implicitly consider 
  high-spectral-resolution features of molecular absorption within each band. 
  With \codeidx{wavelength\_grid\_file} pseudo-spectral 
  calculations can be performed, meaning that you can calculate radiation 
  at any wavelength you want, but it is always a weighted mean calculated 
  from radiative transfer calculations at so-called representative 
  wavelengths of the belonging band - if you select the wavelengths too close, 
  you will see the steps in your spectrum. \codeidx{wavelength\_grid\_file} is particularly useful
  if the default resolution is too expensive for your application.
  If you need a higher spectral resolution of the band data use 
  \code{mol\_abs\_param reptran fine/medium}.

  The spectral parameterizations can be switched off with \code{mol\_abs\_param crs}.
  This can be necessary for example for wavelength below 205nm, or 
  if you want to use your own high-spectral resolution atmospheric data.
  In this case, the radiative transfer calculations are performed on
  the grid provided by \codeidx{wavelength\_grid\_file}. 
  Finally, in order to calculate integrated
  shortwave or integrated longwave radiation, please choose one of the
  pre-defined correlated-k distributions, e.g. 
  \code{mol\_abs\_param kato2} or 
  \code{mol\_abs\_param fu} because these are not only much more
  accurate but also much faster than a pseudo-spectral
  calculation. Please read the respective sections in the manual to
  become familiar with the \codeidx{mol\_abs\_param} options.
  
\item {\bf Quantities}
  
  The next point one needs to consider is the desired radiation
  quantity. Per default, {\sl uvspec} provides direct, diffuse downward
  and diffuse upward solar irradiance and actinic flux at the
  surface. Thermal quantities can be calculated with \code{source thermal} 
  \index{source} -
  please note that {\sl uvspec} currently does either solar or thermal,
  but not both at the same time. If both components are needed (e.g. for
  calculations around 3$\mu$m) then {\sl uvspec} needs to be called
  twice. To calculate radiances in addition to the irradiances, simply
  define \code{umu}, \code{phi}, and \code{phi0} (see next section).
  
\item{\bf Geometry}

  Geometry includes the location of the sun which is defined with \codeidx{sza}
  (solar zenith angle) and \codeidx{phi0} (azimuth). The azimuth is only required
  for radiance calculations. Please note that not only the solar zenith
  angle but also the sun-earth-distance change in the course of the year
  which may be considered with \codeidx{day\_of\_year} (alternatively,
  \code{latitude}, \code{longitude}, and \code{time} may be used). The altitude of the
  location may be defined with \codeidx{altitude} which modifies the profiles
  accordingly. Radiation at locations different from the surface may be
  calculated with \codeidx{zout} which gives the sensor altitude above the
  ground. For satellites use \code{zout TOA} (top of atmosphere). For
  radiance calculations define the cosine of the viewing zenith angle
  \codeidx{umu} and the sensor azimuth \codeidx{phi} and don't forget to also specify the
  solar azimuth \code{phi0}. \code{umu>}0 means sensor looking downward (e.g. a
  satellite), \code{umu<}0 means looking upward. \code{phi} = \code{phi0} indicates that the
  sensor looks into the direction of the sun, \code{phi}-\code{phi0} = 180$^\circ$ means that
  the sun is in the back of the sensor.

\item{\bf What do you need to setup the atmosphere?}

  To define an atmosphere, you need at least an \codeidx{atmosphere\_file}
  which usually contains profiles of pressure, temperature, air density,
  and concentrations of ozone, oxygen, water vapour, carbon dioxide, and
  nitrogen dioxide. The set of six standard atmospheres provided with
  libRadtran is usually a good start: \code{midlatitude\_summer},
  \code{midlatitude\_winter}, \code{subarctic\_summer},
  \code{subarctic\_winter}, \code{tropical}, and \code{US-standard}. If
  you don't define anything else, you have an atmosphere with Rayleigh
  scattering and molecular absorption, but neither clouds, nor aerosol.
  
  \begin{enumerate}
  \item {\bf Trace gases?}
    
    Trace gases are already there, as stated above. But sometimes you
    might want to modify the amount. There is a variety of options to do
    that, e.g. \code{mol\_modify O3} which modifies the ozone column, or
    \code{mixing\_ratio CO2}, \dots
    
  \item {\bf Aerosols?}
    
    If you want aerosol, switch it on with \codeidx{aerosol\_default} and
    use either the default aerosol or one of the many \code{aerosol\_}
    options to setup whatever you need.
    
  \item {\bf Clouds?}
    
    {\sl uvspec} allows water and ice clouds. Define them with
    \codeidx{wc\_file} and \codeidx{ic\_file} and use one of the many \code{wc\_}
    or \code{ic\_} options to define what you need. Please note that for
    water and ice clouds you also have a choice of different
    parameterizations, e.g. \code{ic\_properties fu}, \code{yang},
    \code{baum}, \dots - these are used to translate from liquid/ice water
    content and droplet/particle radius to optical properties. You need
    some experience with clouds to define something reasonable. Here are
    two typical choices for a \code{wc\_file 1D}
    \begin{Verbatim}[fontsize=\footnotesize, frame=single] 
      # z[km] LWC[g/m3] Reff[um]
          2        0        0 
          1      0.1       10
    \end{Verbatim} 
    and an \code{ic\_file 1D}
    \begin{Verbatim}[fontsize=\footnotesize, frame=single] 
      # z[km] IWC[g/m3] Reff[um]
          10         0       0 
           9     0.015      20
    \end{Verbatim}
    The first is a water cloud with effective droplet radius of 10$\mu$m
    between 1 and 2~km, and an optical thickness of around 15; the second
    is an ice cloud with effective particle radius 20$\mu$m between 9 and
    10~km and an optical thickness of about 1.
    
  \item {\bf Surface properties?}
    
    Per default, the surface albedo is zero - the surface absorbs all
    radiation. Define your own monochromatic albedo, a spectral
    \codeidx{albedo\_file} or a BRDF, e.g. for a water surface which is mainly
    determined by the wind speed \codeidx{brdf\_cam u10}.
    
  \end{enumerate}
  
\item {\bf Choice of the radiative transfer equation (RTE) solver}
  
  \index{rte\_solver}
  The RTE-solver is the engine, or heart, in any radiative transfer
  code. All RTE-solvers involve some approximations to the radiative
  transfer equations, or the solution has some uncertainties due to
  the computational demands of the solution method. The choice of
  RTE-solver depends on your problem. For example, if your
  calculations involves a low sun you should not use a plane-parallel
  solver, but one which somehow accounts for the spherical shape of
  the Earth. You may choose between many RTE-solvers in
  {\sl uvspec}. The default solution method to the radiative transfer
  is the discrete ordinate solver \code{disort} which is the method
  of choice for most applications. There are other solvers like
  \code{rte\_solver twostr} (faster but less accurate),
  \code{rte\_solver polradtran} (polarization-dependent solver), or
  \code{rte\_solver sdisort} (pseudo-spherical)\ifmystic{, or \code{rte\_solver
      mystic} (three-dimensional, polarization-dependent solver,
    spherical geometry)}. Even
  lidars can be simulated using \code{rte\_solver sslidar}.
  
\item {\bf Postprocessing}
  
  The spectral grid of the output is defined by the extraterrestrial
  spectrum, which can be modified using \codeidx{source solar file}.
  If you want spectrally integrated results, use either \code{output\_process integrate} 
  for \code{mol\_abs\_param lowtran} and \code{mol\_abs\_param reptran}, 
  or \code{output\_process sum} for \code{mol\_abs\_param kato2}.
  Check also other options like \codeidx{filter\_function\_file}, \codeidx{output\_quantity brightness},
  etc. Instead of calibrated spectral quantities you might also want
  \codeidx{output\_quantity transmittance} or \codeidx{output\_quantity reflectivity}.
  
\item {\bf Check your input}
  
  Last but not least, make always sure that {\sl uvspec} actually
  does what you want it to do! A good way to do that is to use
  \codeidx{verbose} which produces a lot of output. To reduce the amount,
  it is a good idea to do only a monochromatic calculation. Close to the
  end of the verbose output you will find profiles of the optical
  properties (optical thickness, asymmetry parameter, single scattering
  albedo) which give you a pretty good idea, e.g. if the clouds which you
  defined are already there, where the aerosol is, etc. As a general
  rule, never trust your input, but always check, play around, and
  improve. For if thou thinkest it cannot happen to me and why bother to
  use the verbose option, the gods shall surely punish thee for thy
  arrogance!
  
\end{enumerate}

\subsection{How to translate old input files?}
\label{sec:translate}

Since {\sl libRadtran} version 1.8 input option names have changed.
In the directory src\_py/ you will find a program translate.py 
to translate old style input files to new style input files.

To translate your input file use the following command:
\fcode{
python translate.py filename
}

To save the output into a new filename use:
\fcode{
python translate.py filename -\,-new\_filename=new\_inputname
}

To overwrite your old input file use:
\fcode{
python translate.py filename -\,-new\_filename=filename -\,-force
}


\subsection{Output from {\sl uvspec}}
\label{sec:model_output}

The {\sl uvspec} output depends on the radiative transfer solver. The output
formats are described in the following. The meaning of the symbols is
described in Table~\ref{tab:symbols}. The output may be user
controlled to some degree using the option \code{output\_user}.

\subsubsection{disort, sdisort and spsdisort}
For the disort, sdisort and spsdisort solvers {\sl uvspec} outputs
one block of data to 
standard output (stdout) for each wavelength. 

If \code{umu} is not specified the format of the block
is
\begin{Verbatim}[fontsize=\footnotesize, frame=single]  
lambda edir edn eup uavgdir uavgdn uavgup
\end{Verbatim}

If \code{umu} is specified the format of the block is
\begin{Verbatim}[fontsize=\footnotesize, frame=single]  
lambda edir edn eup uavgdir uavgdn uavgup umu(0)
u0u(umu(0)) umu(1) u0u(umu(1)) .  .  .  .
\end{Verbatim}

If both \code{umu} and \code{phi} are specified the output
format of each block is
\begin{Verbatim}[fontsize=\footnotesize, frame=single, samepage=true]   
lambda edir edn eup uavgdir uavgdn uavgup 
                           phi(0)    ...    phi(m) 
umu(0) u0u(umu(0)) uu(umu(0),phi(0)) ... uu(umu(0),phi(m))
umu(1) u0u(umu(1)) uu(umu(1),phi(0)) ... uu(umu(1),phi(m)) 
  .         .           .                        .
  .         .           .                        .
umu(n) u0u(umu(n)) uu(umu(n),phi(0)) ... uu(umu(n),phi(m))
\end{Verbatim}
and so on for each wavelength.


\subsubsection{twostr and rodents}
The format of the output line for the twostr
solver is
\begin{Verbatim}[fontsize=\footnotesize, frame=single]  
lambda edir edn eup uavg
\end{Verbatim}
for each wavelength.


\subsubsection{polradtran}
The output from the \code{polradtran} solver
depends on the number of Stokes parameters,
\code{polradtran nstokes}. 

If \code{umu} and \code{phi} are not specified the output block is
for each wavelength
\begin{Verbatim}[fontsize=\footnotesize, frame=single, samepage=true]  
lambda down_flux(1) up_flux(1) ...  down_flux(is) up_flux(is)
\end{Verbatim}
Here \code{is} is the number of Stokes parameters specified by
\code{polradtran nstokes}. 

If \code{phi} and \code{umu} are specified the block is
\begin{Verbatim}[fontsize=\footnotesize, frame=single, samepage=true]  
lambda down_flux(1) up_flux(1) ...  down_flux(is) up_flux(is) 
                              phi(0) ...  phi(m) 
Stokes vector I 
umu(0) u0u(umu(0)) uu(umu(0),phi(0)) ... uu(umu(0),phi(m)) 
umu(1) u0u(umu(1)) uu(umu(1),phi(0)) ... uu(umu(1),phi(m)) 
  .     .             .                   .  
  .     .             .                   . 
umu(n) u0u(umu(n)) uu(umu(n),phi(0)) ... uu(umu(n),phi(m))
Stokes vector Q 
 .      .  
 .      . 
\end{Verbatim}
Note that \code{polradtran} outputs the total
(=direct+diffuse) downward flux. Also note that \code{u0u} is always zero for
\code{polradtran}.

\ifmystic{
\subsubsection{mystic}

Monte Carlo is the method of choice (1) for horizontally inhomogeneous
problems; (2) whenever polarization is involved; (3) for applications where
spherical geometry plays a role; and (4) whenever sharp features of the 
scattering phase function play a role, like for the calculation of the
backscatter glory or the aureole. The format of the output files of the
\code{mystic} solver is described in section~\ref{sec:mystic}.   
}

\subsubsection{sslidar}
\label{subsubsec:sslidar-output}

The format of the output line for the sslidar
solver is
\begin{Verbatim}[fontsize=\footnotesize, frame=single]  
center-of-range number-of-photons lidar-ratio
\end{Verbatim}
for each range bin.

\subsubsection{Description of symbols}

The symbols used in section~\ref{sec:model_output} are described in
table~\ref{tab:symbols}.

\begin{table}
  \centering
  \begin{tabularx}{1.0\hsize}{lX}
    Symbol & Description \\ \hline
    \code{cmu} &  Computational polar angles from \code{polradtran}. \\
    \code{down\_flux}, \code{up\_flux} & The total
    (direct+diffuse) downward (\code{down\_flux}) and upward (\code{up\_flux})
    irradiances.  Same units as extraterrestrial irradiance
    ( e.g mW/(m$^2$ nm) if using the \file{atlas3}
    spectrum in the \file{data/solar\_flux} directory.)\\ 
    \code{lambda} & Wavelength (nm) \\
    \code{edir}& Direct beam irradiance w.r.t. horizontal plane (same unit as
    extraterrestrial irradiance). \\
    \code{edn}& Diffuse down irradiance, i.e. total
    minus direct beam (same unit as \code{edir}). \\
    \code{eup}& Diffuse up irradiance (same unit as
    \code{edir}).\\
    \code{uavg}& The mean intensity. Proportional to the
    actinic flux: To obtain the actinic flux, multiply the mean intensity
    by 4$\pi$ (same unit as \code{edir}).\\
    \code{uavgdir}& Direct beam contribution to the mean
    intensity (same unit as \code{edir}).\\
    \code{uavgdn}& Diffuse downward radiation
    contribution to the mean intensity (same unit as \code{edir}).\\
    \code{uavgup}& Diffuse upward radiation contribution
    to the mean intensity (same unit as \code{edir}).\\
    \code{u0u} & The azimuthally averaged intensity at \code{numu} 
    user specified angles \code{umu} (units of e.g. mW/(m$^2$ nm
    sr) if using the \file{atlas3} spectrum in the \file{data/solar\_flux}
    directory.) Note that the intensity correction included in the disort solver 
    is not applied to \code{u0u}, thus u0u can deviate from the 
    azimuthally-averaged intensity-corrected \code{uu}.\\
    \code{uu} & The radiance (intensity) at \code{umu}
    and \code{phi} user specified angles (unit e.g. mW/(m$^2$ nm sr) if using
    the \file{atlas3} spectrum in the \file{data/solar\_flux} directory.)\\
    \code{uu\_down}, \code{uu\_up} & The downwelling and
    upwelling radiances (intensity) at \code{cmu} and \code{phi} angles
    (unit e.g. mW/(m$^2$ nm sr) if using the \file{atlas3} spectrum in the
    \file{data/solar\_flux} directory.)\\
  \end{tabularx}
  \caption{Description of symbols used in the description of the model
    output.}
  \label{tab:symbols}
\end{table}

\noindent The total downward irradiance is given by

\begin{Verbatim}[fontsize=\footnotesize]
  eglo = edir + edn
\end{Verbatim}

\noindent The total mean intensity is given by

\begin{Verbatim}[fontsize=\footnotesize]  
  uavg = uavgdir + uavgdn + uavgup
\end{Verbatim}

\noindent If \code{deltam} is on it does not make sense to look at the
direct and diffuse contributions to \code{uavg} separately since they
are delta-M scaled (that is, the direct would be larger than expected
and the diffuse would be smaller).

\section{RTE solvers included in  {\sl uvspec}}
\label{sec:RTEsolvers}

The {\sl uvspec} tool includes numerous radiative transfer equation
solvers. Below their capabilities and limitations are briefly
described. A complete technical description of all solvers is far
beyond the scope of the present document. The reader is referred to
the individual papers describing the specific solver (see references
for each solver). The solvers as they are named in the {\sl uvspec}
input files are written in {\bf bold}. They also appear within the
parenthesis in the subsection heads below. A list of all the solvers is
provided in Table~\ref{tab:rte_solvers}. 

\begin{table*}[htbp]
  \caption[]
  {\label{tab:rte_solvers}The radiative transfer equation solvers
    currently implemented in {\em libRadtran}.}
  \smallskip
  \renewcommand{\arraystretch}{1.2}
  \begin{tabularx}{1.0\hsize}{lp{1.5cm}lp{4cm}X}
    \hline
    RTE        & Geometry & Radiation       & Reference            &
    Comments        \\ 
    solver     &          & quantities      &                      &
    \\ 
    \hline
    disort & 1D, PP, PS & E, F, L         & \citet{buras2011b}  &
    discrete ordinate (C-version)\\ 
    \ifmystic{MYSTIC     & 3D, 1D, PP, SP & E, F, \bf{I}&
      \citet{mayer2009, emde2007, emde2010, buras2011a, emde2011} & Monte Carlo$^{(a)}$, polarization}\\
    fdisort1 & 1D, PP & E, F, L         & \citet{Stamnes1988c}    &
    discrete ordinate (DISORT 1.3) \\ 
    fdisort2 & 1D, PP & E, F, L         & \citet{stamnes2000}  &
    discrete ordinate (DISORT 2.0) \\ 
    polradtran & 1D, PP & E, F, {\bf I}    & \citet{Evans1991}    &
    polarization included \\ 
    twostr     & 1D, PS & E, F            & \citet{Kylling1995}  & two-stream; \\ 
    &        &                 &                      &
    pseudo-spherical correction\\ 
    rodents    & 1D, PP & E,F             & \citet{Zdunkowski2007}     & Note that the reference contains errors (see next section) \\
    sdisort    & 1D, PS & E, F, L         & \citet{Dahlback1991}   &
    pseudo-spherical correction, \newline double
    precision, customized  \newline for airmass calculations\\
%    qdisort    & 1D, PS & E, F, L         & \citet{Kylling1992}  &
%    based on sdisort, includes extra \newline  source term used for Raman 
%    \newline scattering  \\
    spsdisort  & 1D, PS & E, F, L         & \citet{Dahlback1991}   &
    pseudo-spherical {correction}, \newline single
    precision, not suitable for cloudy conditions\\ 
    tzs        & 1D, PP & L(TOA)          &                      & thermal, zero scattering \\
    sss        & 1D, PP & L(TOA)          &                      & solar, single scattering \\
    sslidar    & 1D, PP & $\ast$          &                      & \\
    \hline
    \multicolumn{5}{l}{$^{(a)}$ partial (1D) version included in the free package; available in joint projects}\\
    Explanation: & \multicolumn{2}{l}{PP, plane-parallel}    & \multicolumn{2}{l}{E, irradiance}   \\
    & \multicolumn{2}{l}{PS, pseudo-spherical}  & \multicolumn{2}{l}{F, actinic flux} \\
    & \multicolumn{2}{l}{SP, fully spherical}   & \multicolumn{2}{l}{L, radiance}    \\
 & \multicolumn{2}{l}{1D, one-dimensional}   &
      \multicolumn{2}{l}{L(TOA), radiance at top of atmosphere}   \\
    & \multicolumn{2}{l}{3D, three-dimensional} & \multicolumn{2}{l}{$\ast$ sslidar: see section~\ref{subsubsec:sslidar-output}.} \\
    \multicolumn{5}{l}{{\bf I} indicates the Stokes vector, L is it's
      first element.}\\
  \end{tabularx}
\end{table*} 

\subsection{DIScrete ORdinate Radiative Transfer solvers (DISORT)}
The discrete ordinate method was developed by \citet{chand60}
and \citet{Stamnes1988c}.  It solves the radiative transfer
in 1-D geometry and allows accurate calculations of radiance,
irradiance, and actinic flux. The standard DISORT solver developed 
by \citet{Stamnes1988c,stamnes2000} is probably the most versatile, well-tested
and mostly used 1D radiative transfer solver on this planet.

The {\sl uvspec} model includes the standard
DISORT solvers which are available from
\url{ftp://climate1.gsfc.nasa.gov/wiscombe/Multiple_Scatt/}. In
addition, a number of special purpose disort-family solvers are included.

From a historic point of view it is of interest to note that the
first version of {\sl uvspec} was based on the DISORT solver.

\subsubsection{DISORT solvers (disort, fdisort1, fdisort2)}
This group of solvers solve the 1D plane-parallel radiative transfer
equation~\ref{eq:DiffuseRTE}.  A very complete and thorough
description of the nitty-gritty details of the standard DISORT solver
has been provided by \citet{stamnes2000}. The theory behind is clearly
elucidated by \citet{Thomas1999}. Three versions of the DISORT solver
are included in {\sl uvspec}.
\begin{description}
\item[fdisort1] The original fortran77 DISORT version 1.3.
\item[fdisort2] The fortran77 DISORT version 2.0, with several improvements.
\item[disort] The C version of DISORT version 2.0, translated from
  fdisort2 by T.~Dowling \citep{buras2011b}, can also be used in
  pseudo-spherical mode.
\end{description}
The major changes between version 1.3 and 2.0 includes improved
treatment for peaked phase functions and a realistic handling of the
bidirectional reflectance function (BRDF). The modified version \code{
  fdisort2} (and \code{disort}) further improves the treatment
of peaked phase functions. Important improvements to the intensity
correction method by \cite{nakajima1988} are described in
\cite{buras2011b}.

\code{disort} is the C version of fdisort2. The C version runs in
double precision, produces less instabilities, and is slightly
faster. Further, it can be used in pseudo-spherical mode.

If you are in doubt, use \code{disort}, which is the default RTE solver
in {\sl uvspec}. If you are worried about spherical effects please use
the additional option \code{pseudospherical}.


\subsubsection{Pseudo-spherical DISORT (sdisort, spsdisort)}
\citet{Dahlback1991} extended the DISORT version 1.3 solver to
pseudo-spherical geometry by solving equation~\ref{eq:DiffuseRTE}. The
\code{sdisort} solver includes further 
improvements, for instance the possibility to include 2D density profiles
of trace gases. This option is of importance for air mass factor (AMF)
calculations relevant for analysis of DOAS measurements. The
\code{sdisort} solver does not include the improvements of DISORT version
2.0.

Note that \code{sdisort} is not a fully spherical solver and may thus
not be used for limb geometry.

The \code{spsdisort} solver is a single precision version of {\bf
  sdisort}. Unless you have a 64-bit processor with compilers that do
the numerics using all 64-bits we do not recommend that you use it
because of numerical instabilities caused by the limited numerical
resolution of 32-bits CPUs.

%\subsubsection{General source term (qdisort)}
%The \code{qdisort} solver is similar to \code{sdisort} with the addition
%of a general source term to the right in Eq.~\ref{eq:pseudoDiffuseRTE}. It
%is only used when Raman scattering is included the calculation.


\subsubsection{Two-stream solvers (twostr, rodents)}
The DISORT solver are multi-stream solvers and thus not optimized for
fast two-stream calculations. The \code{twostr} solver was developed by
\citet{Kylling1995} and solves equation~\ref{eq:DiffuseRTE}. Being a
two-stream solution, \code{twostr} can not calculate
radiances. Furthermore, based on the accuracy requirements of the
specific application, the user is encouraged to make sample
sensitivity test of \code{twostr} results versus for example \code{sdisort}.

Note that you need to use the option \code{pseudospherical} in order
to use the solver described in \citet{Kylling1995}, else you are using
the plane-parallel version.

The \code{rodents} solver is the delta-Eddington twostream method
presented in \cite{Zdunkowski2007}, Sect.~6. Note that the equations
(6.50) and (6.88) in the reference are wrong. Also note that the
thermal radiation is not implemented as described on page 178 of the
reference, but in analogy to the solar radiation. The solver was
implemented by Robert Buras, hence the name ``ROberts' Delta-EddingtoN
Two-Stream''.

\subsection{Polarization (polradtran)}
The \code{polradtran} solver developed by \citet{Evans1991} solves the
plane-parallel RTE including polarization in 1D. It should be
noted that \code{polradtran} is not accurate for strongly peaked phase
functions that are typical for water and ice cloud scattering in the
shortwave spectral region. \ifmystic{For these applications the
\code{mystic} solver should be used.}

%\subsection{sos}
%\FIXME{MORE TO COME}

\subsection{Thermal zero scattering (tzs)}
The \code{tzs} solver developed by Luca Bugliaro is a fast solver to
calculate thermal radiances at the top of the
atmosphere for a non-scattering atmosphere. It may also be used to
calculate ``black cloud'' radiances. The cloud top heights can be
specified using the option \code{tzs\_cloud\_top\_height}. 
\code{tzs} has been used to apply the so
called CO$_2$ slicing algorithm for the determination of cloud top
temperatures from satellite based passive remote sensing measurements.

% CE: commented equation because it is not consistent with paper. 
% In this case, the
% radiative transfer equation reduces to
% \begin{equation}
%  - \mu {dI(z,\mu,\phi) \over \beta^{ext}dz}=I(z,\mu,\phi)-(1-\omega(z))B[T(z)]
% \end{equation}
% where $I(z,\mu,\phi)=I(z,\mu,\phi, \nu)$ represents the spectral
% radiance at the wavenumber $\nu$, $\omega(z)=\omega(z,\nu)$ is the
% single scattering albedo, $\beta^{ext}=\beta^{ext}(\nu)$ the exctinction 
% coefficient and $B[T(z)]=B[T(z),\nu]$ is Planck's
% function for temperature $T$. This local problem can be solved by
% assuming a one-dimensional atmosphere that is split into a number of
% isothermal layers.



%\subsection{Solar single scattering (sss)}
%The \code{sss} solver solves the scalar RTE for single scattered radiation in a 1D
%plane-parallel atmmosphere. It includes solar radiation. Radiation is
%only output at the top of the atmosphere radiance as a function of
%$\mu$ and $\phi$.  

%\FIXME{Include equations}

%\subsection{Solar single scattering (sssi)}
%Similar to the \code{sss} solver, but includes a correction for
%reflecting cloud layers. It currently only works for nadir radiance.

%\FIXME{Include equations}

\subsection{sslidar}

The solver basically returns the solution of the lidar equation
(\ref{eq:sslidar}) and the lidar ratio,
Eq.~(\ref{eq:lidar_ratio}). The overlap function is set to 1. Input
parameters for this solver are:

\begin{description}
\item[sslidar area] Detector area in units of m$^2$ (default: 1m$^2$)
\item[sslidar E0] Energy of laser pulse in units of J (default: 0.1J) 
\item[sslidar eff] Detector efficiency (default: 0.5)
\item[sslidar position] Altitude of position of lidar in units of km (default: 0km)
\item[sslidar range] width of range bin in units of km (default: 0.1km)
\item[sslidar\_nranges] Number of range bins (default: 100)
\end{description}

Also, the cosine of the nadir angle into which the lidar is
shooting/looking can be set using the option \code{umu} (default: 0).

The result is evaluated in the center of each range bin, i.e.~the
extinction from one range bin to the next is integrated correctly up
to the middle of the range bin, where the backscatter coefficient is
evaluated. This is then multiplied with the width of the range bin in
order to get the number of photons detected in this range bin. The
lidar ratio is also evaluated in the center of each range bin.

%Note: surface reflection is not yet implemented. Spectral integration
%is not yet implemented.
\ifmystic{
  \input{mystic}
}

\section{Examples}
\label{sec:examples}

In the following sections, several
examples are given, how to create an input file, how to define a
cloudless sky atmosphere, how to add aerosols and clouds, etc. All
examples are taken from the libRadtran examples directory
and are part of the {\sl uvspec} self-check. For a complete listing
and explanation of all input options, have a look at section~\ref{sec:uvspec_options}.
More examples of {\sl uvspec} input files
(extension \file{.INP}) are found in the \file{examples}
directory. Several examples are also availabe through the
{\sl uvspec} Graphical User Interface (see \file{GUI} directory).


\subsection{Cloudless, aerosol-free atmosphere}

The simplest possible input file contains only a few lines:
\efile{../examples/UVSPEC_SIMPLE.INP}

The first two statements define the location of some data files: the
the atmospheric profile\index{atmospheric profile}
(\codeidx{atmosphere\_file}), 
and the extraterrestrial spectrum\index{extraterrestrial spectrum} 
(\codeidx{source solar file}). The third line
defines the desired wavelength range which is a monochromatic data
point in this example. All other data which are not explicitely
mentioned assume a default value which is "0" in most cases. Here, the
solar zenith angle is 0, the surface albedo is 0, and the atmosphere
does not contain clouds nor aerosols. Pressure, temperature, ozone
concentration, etc. are read from \code{atmosphere\_file}.

An example of a more complete input file for a clear sky atmosphere is:

\efile{../examples/UVSPEC_CLEAR.INP}
% CE: commented the following paragraph. Misleading, because only the
% first two lines of the input file are described, then a completely
% different toptc starts. 
% The atmosphere model, i.e. pressure, temperature, and ozone
% concentration profiles are read from
% \file{../data/atmmod/afglus.dat}. The extraterrestrial solar flux is
% read from the file \file{../data/solar\_flux/atlas\_plus\_modtran}.

A wavelength dependent {\bf surface albedo}\index{surface albedo}
may be specified using
\codeidx{albedo\_file} instead of \codeidx{albedo}. Non-Lambertian surface
reflectance (BRDF) \index{BRDF} for vegetation and water may also be defined
(please note that these require the use of \code{rte\_solver
disort}). The BRDF of vegetation is specified using \codeidx{brdf\_rpv rho0},
\codeidx{brdf\_rpv k}, and \codeidx{brdf\_rpv theta}, following the definition of
\citet{rahman93a}. Wavelength-dependent BRDF for vegetation can be
defined with \codeidx{rpv\_file}. The BRDF of water surfaces is
parameterized following \citet{cox54a, cox54b} and \citet{nakajima83}.
The respective parameters are the wind speed
\codeidx{brdf\_cam u10}, the pigment concentration
\codeidx{brdf\_cam pcl}, and the salinity
\codeidx{brdf\_cam sal}. A complete description of these parameters
is given in section~\ref{sec:uvspec_options}.

\index{wavelength grid}
\index{spectral resolution}
It is helpful to know some details about the {\bf input/output
wavelength resolution} in {\sl uvspec} and how it can be influenced
by the user. Basically there are three independent wavelength grids,
the \strong{input grid}, the \strong{internal grid}, and the
\strong{output grid}. Note, that the internal grid is separated in 
two individual grids when REPTRAN is used, as described below.
The essential thing to know is that the internal
grid is chosen by {\sl uvspec} itself in a reasonable way, if not
explicitely defined in the input file with
\codeidx{wavelength\_grid\_file} or \codeidx{mol\_tau\_file abs}. The
output grid is completely independent of the internal grid and is
entirely defined by \codeidx{source solar file} or \codeidx{source thermal file}. 
The wavelength grids of all
other input data (e.g. albedo, optical properties of aerosols and
clouds, etc) are also completely independent. These data are
automatically interpolated to the resolution of the internal
wavelength grid. Hence, only two constraints are set to the gridding
of the input data: (1), the wavelength range has to cover all internal
grid points; and (2), it should be chosen in a reasonable manner to
allow reasonable interpolation (which essentially means, dense
enough).

For spectrally resolved calculations (\code{mol\_abs\_param crs}) in the ultraviolet/visible, 
  {\sl uvspec} uses an internal grid with a
step width of 0.5nm below 350nm and 1nm above 350nm. This is a
conservative choice which fully resolves the broad ozone absorption
bands and the slowly varying Rayleigh, aerosol, and cloud
extinctions. The idea is outlined in figure~\ref{fig:transpz} which is
taken from \citet{Mayer1997}.

\begin{figure}[t]
  \centering
  \includegraphics[width=1.\hsize]{figs/transpz.pdf}
  \caption{{\sl uvspec} calculation of spectral irradiance in the
    ultraviolet range. (Top left) High-resolution extraterrestrial irradiance
    \citet{kurucz92}, averaged over 0.1 nm intervals. 
    (Top right) Low-resolution atmospheric
    transmittance for US standard 
    atmosphere, solar zenith angle 0$^\circ$. 
    (Bottom) Product of both: spectral irradiance.}
  \label{fig:transpz}
\end{figure}

The transmittance (or reflectance) is calculated on a moderate
resolution grid which reduces the number of calls to the
\code{rte\_solver} and hence the computational time. Then, the
transmittance is interpolated to the wavelengths in the
\code{source solar file} (which is usually defined with higher spectral
resolution), multiplied with the extraterrestrial irradiance, and
possibly post-processed.  Hence, the wavelength in the output spectrum
are those contained in the \code{source solar file} which has two important
implications: (1) Only those wavelengths are output that are contained
in the \code{source solar file}. If e.g. a monochromatic calculation is
defined by setting '\code{wavelength 327.14}', there will only be
output if the wavelength 327.14 is explicitely listed in
\code{source solar file}; (2) this is also true at thermal wavelengths where
the extraterrestrial irradiance is zero; hence, even for a calculation
in the thermal range a \code{source thermal file} can be specified which
defines the output grid in the first column and arbitrary values in
the second column. Keeping these points in mind, \code{source solar/thermal file} is
a convenient way to define an arbitrary output
grid. \code{file} may be omitted for thermal radiation
calculations (\code{source thermal}), representative wavelength 
calculations (\code{mol\_abs\_param reptran}), as well as for
\code{output\_quantity transmittance} and \code{output\_quantity reflectivity} calculations. 
If omitted, the output grid equals the internal wavelength grid.

If required, a {\bf user-defined internal grid} can be specified with
\code{wavelength\_grid\_file} or \code{mol\_tau\_file abs}. Note
that this is a way to speed up the calculation considerably. E.g., for
some applications the internal grid in the UV-A and visible can be set
to 10nm which would reduce computational times by up to a factor of
10.

Things are completely different if a k distribution method is selected 
(see below). In this case 
all flexibility is taken away from the user which is an inherent feature
of the k distribution method. Internal grid as well as the
extraterrestrial file are in this case defined by the choice of the
parameterization itself.

\begin{figure}[t]
  \centering
  \includegraphics[width=1.\hsize]{figs/reptran_lambda_grids.pdf}
  \caption{Example for internal wavelength grids when using \codeidx{mol\_abs\_param reptran} (see text for details); 
     the shaded areas illustrate the spectral ranges of the different parameterized adjacent non-overlapping bands.}
  \label{fig:reptran_grid}
\end{figure}

If the band parameterization REPTRAN is used, two internal grids exist, 
as illustrated in Fig.~\ref{fig:reptran_grid}:
The first internal grid (above arrow) by default is defined by the wavelengths at the centers of the bands (line b of Fig.~\ref{fig:reptran_grid}).
The wavelength range is selected using the \codeidx{wavelength} option (line a of Fig.~\ref{fig:reptran_grid}); 
all bands overlapping with the specified wavelength range are modeled, for example bands 3 to 9 in Fig.~\ref{fig:reptran_grid}.
The first internal grid can be specified directly by the user with \codeidx{wavelength\_grid\_file} option (line c of Fig.~\ref{fig:reptran_grid}). 
The second internal grid consists of the representative wavelengths where the radiative transfer calculations are performed (line d of Fig.~\ref{fig:reptran_grid}).
The representative wavelengths grid is created automatically for all bands required for the first internal grid; 
for example, the second internal grid contains only the representative wavelengths required for bands 1, 2, 3, 5, and 8 for the \codeidx{wavelength\_grid\_file} illustrated in line c of Fig.~\ref{fig:reptran_grid}.
After the radiative transfer calculations are finished, transmittances calculated 
at the second internal grid are converted to transmittances at the first internal grid according to
the weighting given by the parameterization. The transmittances at the first internal grid
are used for further processing, i.e. to calculate the results on the output grid.

\subsection{Spectral resolution}

{\sl uvspec} offers five different ways of spectral calculations:
\begin{enumerate}
\item \strong{Spectrally resolved calculation} in the UV and visible
spectral ranges;
\item \strong{Line-by-line calculation} with user-defined molecular
absorption data;
\item \strong{The correlated-k method};
\item \strong{Representative wavelengths} parameterization for spectral 
  calculations and satellite channels as described by \citet{gasteiger2014};
  {\sl uvspec} uses this approach by default;
\item \strong{Pseudo-spectral calculation} with exponential-sum-fit,
from LOWTRAN; code adopted from SBDART \citep{Ricchiazzi1998b}.
\end{enumerate}

The choice of the method is determined by the problem and the decision
is therefore entirely up to the user. The spectrally resolved
calculation and the line-by-line calculation are more or less exact
methods while the correlated-k distribution, the pseudo-spectral
calculation, and representative wavelength method are 
approximations that provide a compromise between speed
and accuracy. In the following it is briefly described which method
fits which purpose:

A \strong{spectrally resolved calculation} is the most straightforward
way, and is a good choice for all users interested in the
ultraviolet and visible spectral ranges. This method is activated by the 
input option \code{mol\_abs\_param crs}. In the UV/VIS gas absorption
generally occurs in broad bands with only slow spectral variation, the
most important of these being the Hartley, Huggins, and Chappuis bands
of ozone. Hence, a radiative transfer calculation every 1nm usually is
sufficient to fully resolve any spectral variation using the method
described in the last section. Absorption cross sections for various
species are included, among them the most important O3 and NO2.

In the infrared, however, molecular absorption spectra are
characterized by thousands of narrow absorption lines. There are two
ways to treat these, either by highly resolved spectral calculations,
so-called \strong{line-by-line} calculations, or by a band
parameterization. Concerning line-by-line, {\sl uvspec} offers the
possibility to define a spectrally resolved absorption cross section
profile using \code{mol\_tau\_file abs}. There is no option in
libRadtran to generate such a \code{mol\_tau\_file abs}, because (1)
the HITRAN database which forms the basis for such calculations
amounts to about 100 MByte which are updated continuously; and (2),
there are sophisticated line-by-line programs available, like
e.g. ARTS \citep{eriksson2011}. Using ARTS it is
straightforward to create the input for {\sl uvspec} line-by-line
calculations since it provides an option to write the absorption optical
thicknesses in the required format. Line-by-line cross sections
available for the six standard profiles that come with libRadtran are
also available on request. Figure~\ref{fig:lblo2a}
shows an example of a line-by-line calculation of the
atmospheric transmittance in two selected solar and thermal spectral
ranges, the O2A-absorption band around 760~nm and a region within the
infrared window around 10~$\mu$m.

\begin{figure}
  \centering
  \includegraphics[width=1.0\hsize]{./figs/lblo2a.pdf}
  \caption{Line-by-line calculation of the
    atmospheric transmittance in two selected solar and thermal spectral
    ranges, the O2A-absorption band around 760~nm and a region within the
    infrared window around 10~$\mu$m.}
  \label{fig:lblo2a}
\end{figure}

All spectral lines in the left figure are due to absorption by oxygen,
while the ones in the right figure are due to ozone, water vapour, and
CO2. Line-by-line is obviously the exact way for radiation
calculations. For most applications, however, line-by-line is far too
slow. Here one needs a band parameterization.
{\sl uvspec} contains several {\bf correlated-k
parameterizations} which are invoked with \code{mol\_abs\_param}, in
particular \citet{Kato1999b, fu92, Kratz1995}, as
well as the possibility to specify a user-defined
one. \citet{Kato1999b}
is a accurate parameterization for the solar spectral
range. {\sl uvspec} contains three different versions:
\begin{description}
\parameter{Kato}
The original tables provide by Seiji
Kato which should correspond to the full version described in Kato et
al. (1999); 575 subbands total, that is, 575 calls to the
\code{rte\_solver}
\parameter{Kato2}
A new, optimized version of the
tables, provided by Seiji Kato, 2003, with only 148 subbands (that is,
calls to the \code{rte\_solver}); the uncertainty is only slightly
higher than \code{Kato}; the absorption coefficients are based on
HITRAN 2000.
\parameter{Kato2.96}
Similar to \code{Kato2} but based on HITRAN96.
\end{description}

Figure~\ref{fig:figure3} shows a comparison between the
three parameterization which are part of libRadtran and the data from
Figure 3 by \citet{Kato1999b}. It is immediately obvious that the
uncertainty is high for all bands above 2.5 micrometer which is
probably due to the treatment of band overlap. For this reasons, the
results for the indiviudal bands should not be trusted while the
integrated shortwave radiation (the sum of all 32 bands) is calculated
with high accuracy because (1) the bands above 2.5 micrometer
contribute only little to the integrated irradiance; and (2) errors
are random and cancel each other to some degree.

\begin{figure}[t]
  \centering
  \includegraphics[width=1.0\hsize]{./figs/figure3.pdf}
  \caption{Comparison between the three parameterization which are
    part of {\sl uvspec} and the data from Figure 3 by \citet{Kato1999b}.}
  \label{fig:figure3}
\end{figure}

For more information on these parameterizations please refer to the
mentioned publications. Correlated-k is a powerful way to calculate
spectrally integrated quantities, however, it takes away some
flexibility. In particular, this means that the wavelength grid is no
longer chosen by the user but by the parameterization, that is, by
{\sl uvspec}. The {\sl uvspec} output is then no longer spectral
quantities, e.g. W/(m$^2$nm), but integrated over the spectral bands,
e.g. W/m$^2$.

A simple but complete example for a correlated-k approximation of the
solar spectrum:

\efile{../examples/UVSPEC_KATO.INP}

Here, the solar spectrum is split up into 32 bands according to
\citet{Kato1999b}.
In order to calculate integrated shortwave irradiance,
simply sum the outputs, or even simpler, add \codeidx{output\_process sum} to the
input file.

As an molecular absorption parameterization, we have implemented the 
\strong{representative wavelength approach} (REPTRAN) in the solar and thermal spectral range.
REPTRAN is used as the default spectral approach in {\sl uvspec}.
Parameterized bands are available for spectral calculations.
Furthermore a number of satellite channels have been parameterized in addition 
(available with \code{mol\_abs\_param reptran\_channel}).
The approach is described by \citet{buehler2010} and \citet{gasteiger2014}.
The required data files are available at the libRadtran homepage.
Band- and channel-integrated quantities are parameterized by weighted sums of these quantities 
calculated at a few representative wavelengths.
Solar bands are parameterized in the spectral range from 395~nm to 5000~nm, thermal bands from 2.5~$\mu$m to 100~$\mu$m.
For both solar and thermal bands different spectral resolutions are available and can be selected using 
\code{mol\_abs\_param reptran coarse|medium|fine} (default: \code{coarse}). \code{fine} corresponds to a band width of 1~cm$^{-1}$, 
whereas widths of 5~cm$^{-1}$ and 15~cm$^{-1}$ are used by \code{medium} and \code{coarse}, respectively.
The solar band parameterizations are extended by 15~cm$^{-1}$ wide bands from 240~nm to 395~nm, where only a single representative 
wavelength (band center) is used for each band.

\begin{figure}
  \centering
  \includegraphics[width=0.49\hsize]{./figs/reptran_solar.pdf}
  \includegraphics[width=0.49\hsize]{./figs/reptran_thermal.pdf}
  \caption{Results of solar and thermal calculations using \code{mol\_abs\_param reptran} for US standard atmosphere.} 
  \label{fig:reptran}
\end{figure}

Figure~\ref{fig:reptran} shows the results of solar and thermal
calculations from 395~nm to 100~$\mu$m. The water vapour absorption bands in the solar range are
clearly visible, as is the absorption window around 10~$\mu$m in
the thermal. 

An example which calculates fluxes at the ground in the solar range is available in \code{examples/UVSPEC\_REPTRAN\_SOLAR.INP}:

\efile{../examples/UVSPEC_REPTRAN_SOLAR.INP}

Internally, the extraterrestrial flux from \citet{kurucz92} is applied, thus no \code{source solar file} is required.

The default unit for solar fluxes is mW/(m$^2$nm), and for thermal fluxes is W/(m$^2$cm$^{-1}$).
Band-integrated quantities are obtained using the option \code{output\_process per\_band}.
The sum over all bands can be calculated using the option \code{output\_process sum}.

The example \code{examples/UVSPEC\_REPTRAN\_THERMAL.INP} calculates brightness temperatures of band-integrated radiances in the thermal range
from different viewing zenith angles at top of atmosphere:

\efile{../examples/UVSPEC_REPTRAN_THERMAL.INP}

Fig.~\ref{fig:o2a} compares the spectral resolutions of REPTRAN and LOWTRAN.
The spectral resolutions are equal for LOWTRAN and REPTRAN medium (5~cm$^{-1}$). 
However spectral information was 
``degraded to 20~cm$^{-1}$ resolution for use in LOWTRAN'' \citep{Ricchiazzi1998b} with the effect that LOWTRAN spectra
are significantly smoother than REPTRAN medium spectra.

Finally, the example \code{examples/UVSPEC\_REPTRAN\_CHANNEL\_THERMAL.INP} calculates the thermal brightness temperatures of a channel of a MSG satellite centered at $\lambda$=3.9$\mu$m looking at different viewing zenith angles:

\efile{../examples/UVSPEC_REPTRAN_CHANNEL_THERMAL.INP}

This setup is the same as in the previous input file whereby channel integrals are calculated instead of band integrals (\code{mol\_abs\_param reptran} of the included file is overwritten by \code{mol\_abs\_param reptran\_channel} here).
The available channels are listed in \code{data/correlated\_k/reptran/channel\_list.txt}.

Though we recommend REPTRAN for spectral calculations, the molecular absorption parameterization from
LOWTRAN/SBDART by \citet{Ricchiazzi1998b} is available mainly for compatibility reasons.
LOWTRAN allows for \strong{pseudo-spectral calculations} in the whole spectral range, the respective 
section of this paper says:

\begin{quotation} 
  SBDART relies on low-resolution band models
  developed for the LOWTRAN 7 atmospheric trans-mission code (Pierluissi
  and Peng, 1985).
  These models provide clear-sky atmospheric
  transmission from 0 to 50000 cm-1 and include the effects of all
  radiatively active molecular species found in the earth s
  atmosphere. The models are derived from detailed line-by-line
  calculations that are degraded to 20 cm-1 resolution for use in
  LOWTRAN. This translates to a wavelength resolution of about 5 nm in
  the visible and about 200 nm in the thermal infrared. These band
  models represent rather large wavelength bands, and the transmission
  functions do not necessarily follow Beers Law. This means that the
  fractional transmission through a slab of material depends not only on
  the slab thickness, but also on the amount of material penetrated
  before entering the slab. Since the radiative transfer equation solved
  by SBDART assumes Beers Law behavior, it is necessary to express the
  transmission as the sum of several exponential functions (Wiscombe and
  Evans, 1977). SBDART uses a three-term exponential fit, which was also
  obtained from LOWTRAN 7. Each term in the exponential fit implies a
  separate solution of the radiation transfer equation. Hence, the RT
  equation solver only needs to be invoked three times for each spectral
  increment. This is a great computational economy compared to a higher
  order fitting polynomial, but it may also be a source of significant
  error.
\end{quotation}

The LOWTRAN/SBDART gas parameterization is invoked with
\code{mol\_abs\_param LOWTRAN}. The spectral resolution may be
arbitrarily chosen by the user. If not explicitely defined with
\code{wavelength\_grid\_file}, an internal grid with a step width of
0.5nm below 350nm and 1nm above 350nm is chosen which is practically
overkill for most applications in the infrared. An extraterrestrial
spectrum covering the complete solar range is provided at two
different resolutions, \code{data/solar\_flux/kurudz\_1.0nm.dat} and
\code{data/solar\_flux/kurudz\_0.1nm.dat}. An example for the solar
range is shown in \code{examples/UVSPEC\_LOWTRAN\_SOLAR.INP}:

\efile{../examples/UVSPEC_LOWTRAN_SOLAR.INP}

while \code{examples/UVSPEC\_LOWTRAN\_THERMAL.INP} shows how to do a
thermal calculation:

\efile{../examples/UVSPEC_LOWTRAN_THERMAL.INP}

Please note the following points:
\begin{itemize}
\item Thermal radiation is per default output in W/(m$^2$cm$^{-1}$), if the
  bandwidth is equal to 1~cm$^{-1}$ (default for \code{mol\_abs\_param LOWTRAN}
  calculations). Otherwise the output is the integrated flux over the
  wavenumber interval specified by \code{thermal\_bandwidth},
  \code{thermal\_bands\_file}, or by the \code{mol\_abs\_param} option
  (Kato, Kato2, Kato2.96, Fu, AVHRR\_KRATZ, or Generic). To convert
  e.g. to W/(m2 nm) use \code{output\_process per\_nm} or multiply with k/lambda
  where k is the wavenumber [cm$^{-1}$] and lambda is the wavelength [nm]. To
  calculate band-integrated thermal quantities please consider
  \codeidx{thermal\_bands\_file}.
\item Even though no extraterrestrial irradiance is required, a
  \code{source thermal file} may be specified for the thermal case. The reason
  is that, as explained initially, the \code{source thermal file} defines the
  output grid. The second column in \code{source thermal file} can be chosen
  arbitrarily in this case because it is ignored.
\item For the choice of the wavelength grid for the calculation
  (\code{wavelength\_grid\_file}) please consider that the resolution
  of the absorption parameterization is 5~cm$^{-1}$ which translates to 0.3nm
  at 750~nm and to 50~nm at 10~$\mu$m. Choosing higher resolutions for
  the internal wavelength grid (\code{wavelength\_grid\_file}) is
  usually a waste of computational time.
\item Please also make sure to choose a fine enough spectral
  resolution in order to capture all absorption features.
\end{itemize}

\begin{figure}
  \centering
  \includegraphics[width=1.0\hsize]{figs/resolution_o2a.pdf}
  \includegraphics[width=1.0\hsize]{figs/resolution_o3.pdf}
  \caption{Two selected wavelength intervals in the
    solar range (upper panel, O2A band) and the thermal range 
    (lower panel, O3 band at $\lambda\approx9.6\mu$m), to demonstrate the spectral resolution of the
    LOWTRAN and REPTRAN absorption parameterizations.}
  \label{fig:o2a}
\end{figure}

The red curve in Fig.~\ref{fig:o2a} demonstrates the spectral resolution of the LOWTRAN/SBDART 
absorption parameterization (and REPTRAN, see above)
for two selected wavelength intervals of the solar and thermal range.
The resolution of LOWTRAN is about 5~cm$^{-1}$ which translates to about 0.3~nm in the
left figure (oxygen A-band) and 50nm in the right figure (ozone
absorption band in the atmospheric window). Compare this figure to the
above line-by-line example to get an impression about the differences
between the methods.


\subsection{Aerosol}
\index{Aerosol}
All options to set up and modify aerosol properties start with
\code{aerosol\_}.  Aerosols may be specified in a hierarchical
way. The most simple way to define an aerosol is by the command
\codeidx{aerosol\_default} which will set up the aerosol model by
\citet{shettle89}. The default properties are a rural
type aerosol in the boundary layer, background aerosol above 2km,
spring-summer conditions and a visibility of 50km. These settings may
be modified with \codeidx{aerosol\_haze}, \codeidx{aerosol\_vulcan},
\code{aerosol\_season}, and \codeidx{aerosol\_visibility}. More
information can be introduced step by step, overwriting the default
parameters. \codeidx{aerosol\_file tau}, \codeidx{aerosol\_file ssa}, and
\codeidx{aerosol\_file gg}, can be used to define the profiles of
optical thickness, single scattering albedo, and asymmetry
parameter. The integrated optical thickness can be set to a constant
value using \codeidx{aerosol\_modify tau set} or scaled with
\codeidx{aerosol\_modify tau scale}. The single scattering albedo may be scaled
by \codeidx{aerosol\_modify ssa scale} or set to a constant value by
\codeidx{aerosol\_modify ssa set}.  The aerosol asymmetry factor may be set by
\codeidx{aerosol\_modify gg set}. The wavelength dependence of the aerosol
optical depth is specified using the \codeidx{aerosol\_angstrom}
parameter. \codeidx{aerosol\_file moments} allows specification of the
scattering phase function. If microphysical properties are available
these may be introduced by defining the complex index of refraction
\codeidx{aerosol\_refrac\_index} and the
size distribution \codeidx{aerosol\_sizedist\_file}. Finally, one may
define the aerosol optical properties of each layer explicitely using
\codeidx{aerosol\_file explicit}.

The following list is an overview of some aerosol description
parameters. The entries are arranged in a way that a parameter
'overwrites' all values higher up in the list.

\begin{description}
  \parameter{aerosol\_default} 
  Generate default aerosol according to \citet{shettle89}.
  \parameter{aerosol\_vulcan, aerosol\_haze, aerosol\_season,
    aerosol\_visibility}
  Set \cite{shettle89} aerosol properties (aerosol
  type, visibility)
  \parameter{aerosol\_file explicit}
  Specify optical properties of each
  layer explicitly, that is, extinction coefficient, single scattering
  albedo, and the moments of the phase function (everything as a
  function of wavelength).
  \parameter{aerosol\_file tau , aerosol\_file ssa,
    aerosol\_file gg}
  Overwrite profiles of optical thickness, single
  scattering albedo, and asymmetry parameter
  \parameter{aerosol\_file moments}
  Specify a phase function to be
  used instead of the Henyey-Greenstein phase function
  \parameter{aerosol\_refrac\_index, aerosol\_sizedist\_file}
  Calculate optical properties from size
  distribution and index of refraction using Mie theory. Here is an
  exception from the rule that ALL values defined above are overwritten
  because the optical thickness profile is re-scaled so that the optical
  thickness at the first internal wavelength is unchanged. It is done
  that way to give the user an easy means of specifying the optical
  thickness at a given wavelength.
  \parameter{aerosol\_species\_file} Define profiles of arbitrary aerosol
  types. The profiles will be mixed within {\sl uvspec}. Optical properties
  of the aerosol types can be provided using the option
  \code{aerosol\_species\_library}. One library may be downloaded from
  \url{www.libradtran.org}, it inlcudes aerosol optical properties
  based on size distribution parameters and refractive indices from
  the OPAC database \citep{hess98:_optic_proper_aeros_cloud}. The optical properties
  have been generated using the \code{mie} tool and they include full
  phase matrices, e.g. they are suitable for calculations with
  polarization.  
  \parameter{aerosol\_modify gg/ssa/tau scale/set}
  Overwrite
  profiles of asymmetry parameter and single scattering albedo
  \parameter{aerosol\_angstrom}
  Overwrite the integrated optical
  thickness (profiles are not changed).
\end{description}

An example for a {\sl uvspec} aerosol description is

\efile{../examples/UVSPEC_AEROSOL.INP}

\noindent By combining this with the clear sky example given above a
complete {\sl uvspec} input file including aerosol is constructed.


\subsection{Water clouds \label{seq:wc}}
\index{Water clouds}

All options to set up and modify water cloud properties start with
\code{wc\_}.

The easiest way to define a water cloud is to specify a
\code{wc\_file} which defines the liquid water content and effective
droplet radius at each model layer or level. By combining the
following lines with the clear sky example given above a complete
{\sl uvspec} input file including water clouds is constructed.

\efile{../examples/UVSPEC_WC.INP}

A typical example for a wc\_file looks like:

\begin{Verbatim}[fontsize=\footnotesize, frame=single] 
# z LWC R_eff 
# (km) (g/m3) (um) 
5.000 0 0 
4.000 0.2 12.0 
3.000 0.1 10.0 
2.000 0.1 8.0
\end{Verbatim}

The three columns are the level altitude [km], the liquid water
content [g/m$^3$], and the effective droplet radius [micrometer]. Per
default (since version 1.4), these quantities are interpreted as layer
quantities, and in the above example, the cloud would extend from 2 to
5~km, with e.g. a LWC of 0.2~g/m$^3$ for the layer between 4 and
5~km. Before version 1.4 the \codeidx{wc\_file} was interpreted as level
quantities (unless \codeidx{wc\_layer} was specified). That is, the value
0.2~g/m$^3$ referred to altitude 4.0~km, as e.g. in a radiosonde
profile. The properties of each layer were calculated as average over
the adjacent levels. E.g. the single scattering properties for the
model layer between 3 and 4~km were obtained by averaging over the two
levels 3~km and 4~km. To allow definition of sharp cloud boundaries,
clouds were only formed if both liquid water contents above and below
the respective layer were larger than 0. Hence, in the above example,
the layers between 2 and 3 as well as between 3 and 4~km were cloudy
while those between 1 and 2km and between 4 and 5~km were not. To
switch to the old behaviour, use \codeidx{interpret\_as\_level wc}.

To make sure that the clouds really look as you want them to look, it
is recommended to use the \codeidx{verbose} option. This option shows not
only where the cloud is actually placed, it rather tells the user
exactly how LWC and effective radius are translated into optical
properties, depending on the choice of parameterisation. Please also
note that the definition of the empty top level at 5km is important to
tell {\sl uvspec} where the cloud ends. If omitted, the cloud would
extend all the way to the top of the atmosphere.

There are different ways to convert the microphysical properties to
optical properties. Either a parameterization is used, like the one by
\citet{Hu1993} (which is the default), or by Mie
calculations. The latter are very time-consuming, hence we decided not
to include these online into {\sl uvspec} but rather have an option
to read in pre-calculated Mie tables. The option \codeidx{wc\_properties}
controls the method: \code{hu} selects the \citet{Hu1993}
parameterization, \code{mie} selects pre-calculated Mie tables which
are available at \url{http://www.libradtran.org}. The tables include
the full scattering phase matrices and can therefore be used for
polarization dependent calculations. If \code{wc\_properties
mie} is selected, the model expects one or more Mie cloud property
files including each internal wavelength which is useful for the fixed wavelength
grids used by the correlated-k parameterisations \code{mol\_abs\_param
kato}, \code{mol\_abs\_param fu}, etc. For a spectral calculation with
free wavelength grid, there is also the possibility to use a
pre-defined set of Mie tables (available at the web site) and to
define \code{wc\_properties mie interpolate} to automatically
interpolate the Mie properties to the internal wavelength
grid. Although this is an extremely useful option, please use it
careful because it might consume enourmous amounts of memory. Finally,
there is the option to define an arbitrary file which can be generated
using the \codeidx{mie} tool (see section~\ref{sec:optprop}).

As for the aerosol, there are several options to modify the optical
properties of the clouds. And of course there is also the option of
defining all cloud properties explicitely using \code{wc\_file moments}.

\subsection{Ice clouds \label{seq:ice_clouds}}
\index{Ice clouds}

Ice clouds are generated in a similar way to water clouds.  All
options to set up and modify ice cloud properties start with
\code{ic\_}. The main difference between water and ice clouds is that
the latter usually consist of non-spherical particles. Hence, the
conversion from microphysical to optical properties is much less
defined, and several parameterizations are available. Please note in
addition that there are different definitions of the effective radius.
E.g. the parameterizations by \citet{Key2002} and
\citet{baum05b:_bulk, baum07:_bulk} use the same definition whereas 
\citet{Fu1996} actually
uses another definition (see explanation of
\codeidx{ic\_properties}). Finally, the sharp forward peak which is
typical for ice particles can also be treated differently: E.g.,
\citet{Fu1996} provides delta-scaled optical properties while
\citet{Key2002} uses unscaled parameters (see explanation of
\codeidx{ic\_fu deltascaling}). Figure~\ref{fig:fuyang} illustrates the
implications.  Plotted are extinction coefficient, asymmetry
parameter, and single scattering albedo for ice clouds with an
effective radius of 25 micrometers as a function of wavelength. If
treated consistently, all parameterizations \citet{Key2002},
\citet{Fu1996}, and \citet{baum05b:_bulk, baum07:_bulk} provide nearly
identical results (solid 
lines, default settings in {\sl uvspec}).  If the definition of
effective radius by \citet{Fu1996} and delta-scaling is applied the optical
properties look different. The effect of delta scaling on a radiative
transfer calculation is that the direct irradiance in increased and
the diffuse irradiance is decreased, whereas the global irradiance
remains unchanged.  The definition of the effective radius has a
smaller effect but it modifies also the global irradiance.  Note that
the parameterization by \citet{baum05b:_bulk, baum07:_bulk} is plotted only up
to 2200~nm. The reason is that it does not cover the full spectral
region, it is available for two spectral regions (from 0.4--2.2~$\mu$m
and from about 3--100~$\mu$m).
For the calculation of radiances one should use either
\code{ic\_properties baum}, \code{hey}, \code{baum\_v36} or
\code{yang2013} because these parameterizations include complete
scattering phase functions and do not use approximations like the
Heney-Greenstein phase function.  \code{hey}, \code{baum\_v36} and
\code{yang2013} can also be used for polarized radiative transfer. The
data needed for \code{baum}, \code{hey}, \code{baum\_v36}, and
\code{yang2013} is available at \url{www.libradtran.org}.

\begin{figure}
  \centering
  \includegraphics[width=1.0\hsize]{./figs/fuyang.pdf}
  \caption{Extinction coefficient, asymmetry
    parameter, and single scattering albedo for ice clouds with an
    effective radius of 25~$\mu$m as a function of wavelength for
    various parameterizations.}
  \label{fig:fuyang}
\end{figure}

\subsection{Calculation of radiances}
\index{radiances}

To calculate radiances the following lines will do the job when
combined with the clear sky example above

\efile{../examples/UVSPEC_RADIANCES.INP}

In this example radiances are calculated for the specified directions,
where \code{umu} are the cosines of the viewing zenith directions and
\code{phi} are the viewing azimuth angles.

\ifmystic{
  The following examples shows a complete input file for the calculation
  of polarized radiances using MYSTIC:
  \efile{../examples/UVSPEC_MC_POL.INP}
  This example is only for a 1D clear sky atmosphere. For radiance
  calculations it is strongly recommended to use the local estimate
  method (\codeidx{mc\_escape}, e.g. \citet{marshak2005}) which
  significantly reduces the noise in the results. Further, for
  radiance calculations in the presence of clouds or any other
  particle type with strong forward scattering peak, we strongly
  recommend to use the variance reduction technique VROOM
  (\codeidx{mc\_vroom}, \citet{buras2011a}).} \ifthreedmystic{In order to
  include 3D clouds, a 2D surface albedo, a 2D BRDF, or topography please
  refer to the MYSTIC documentation in section~\ref{sec:mystic}. 
  }

%\subsection{More examples}

%More examples with output are found in the \file{examples} directory.
%Several examples are also availabe through the
%{\sl uvspec} Graphical User Interface (see \file{GUI} directory).       

